#pragma once

#include <Arduino.h>

#include <Adafruit_GFX.h>
#include <Locator.h>
#include <ArduinoJson.h>
#include <vector>
#include <CWPreferences.h>
#include <StatusController.h>

// Commons
#include "IClockface.h"
#include "Icons.h"
#include "picopixel.h"
#include "fonts/atari.h"
#include "fonts/hour8pt7b.h"
#include "fonts/minute7pt7b.h"
#include "PNGRender.h"
#include "CustomSprite.h"
#include "CWHttpClient.h"

#define CLOCKFACE_NAME "cw-cf-0x07"

const uint8_t CW_ICON_CANVAS[] PROGMEM = { 
	0x00, 0x0e, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 
	0x00, 0x3f, 0x80, 0x00, 0x00, 0x40, 0x40, 0x00, 0x1f, 0xc0, 0x7f, 0x00, 0x20, 0x3f, 0x80, 0x80, 
	0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 
	0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 
	0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 0x20, 0x00, 0x00, 0x80, 
	0x20, 0x00, 0x00, 0x80, 0x7f, 0xff, 0xff, 0xc0, 0x80, 0x00, 0x00, 0x20, 0x7f, 0xff, 0xff, 0xc0, 
	0x0e, 0x1f, 0x0e, 0x00, 0x0e, 0x1f, 0x0e, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x1e, 0x1f, 0x0f, 0x00, 
	0x3f, 0xff, 0xff, 0x80, 0x3c, 0x1f, 0x07, 0x80, 0x3c, 0x1f, 0x07, 0x80, 0x18, 0x0e, 0x03, 0x00
};

class Clockface : public IClockface
{
private:
  Adafruit_GFX *_display;
  CWDateTime *_dateTime;
  uint16_t delay;

  void setFont(const char *fontName);
  bool deserializeDefinition();
  void clockfaceSetup();
  void clockfaceLoop();
  void renderElements(JsonArrayConst elements);
  void renderText(String text, JsonVariantConst value);
  void createSprites();
  void refreshDateTime();
  void drawSplashScreen(uint16_t color, const char *msg);
  void handleSpriteAnimation(std::shared_ptr<CustomSprite> &sprite);
  void handleSpriteMovement(std::shared_ptr<CustomSprite> &sprite);

  std::vector<std::shared_ptr<CustomSprite>> sprites;

public:
  Clockface(Adafruit_GFX *display);
  void setup(CWDateTime *dateTime);
  void update();
};
